<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŠãƒˆã‚¯é‚„å…ƒãƒã‚§ãƒƒã‚«ãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; background-color: #f1f5f9; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’å°‘ã—ãŠã—ã‚ƒã‚Œã« */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="min-h-screen pb-20 text-slate-800">
    <div class="max-w-2xl mx-auto px-6 pt-10">
        <header class="mb-8">
            <h1 class="text-4xl font-black text-slate-900 tracking-tighter italic">é‚„å…ƒãƒã‚§ãƒƒã‚«ãƒ¼</h1>
            <p class="text-xs font-bold text-slate-400 mt-1 uppercase tracking-widest">LLM-based Reward Analysis</p>
        </header>

        <section class="bg-white rounded-2xl p-6 mb-8 border border-slate-200 card-shadow">
            <div class="grid grid-cols-2 gap-6">
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-bold text-slate-500 uppercase">ä¸‰äº•ä½å‹ã‚«ãƒ¼ãƒ‰ (æœ€å¤§20%)</label>
                        <a href="https://www.smbc-card.com/mem/wp/vpoint_up_program/index.jsp" target="_blank" class="text-xs text-green-600 underline hover:text-green-700">å…¬å¼è©³ç´°</a>
                    </div>
                    <div class="flex items-center bg-slate-50 rounded-xl px-4 py-3 border border-slate-200 focus-within:border-green-600 focus-within:ring-2 focus-within:ring-green-100 transition-all">
                        <input type="number" id="smbc-rate" step="0.5" class="bg-transparent w-full font-black outline-none text-green-700 text-2xl" placeholder="7.0">
                        <span class="text-slate-400 font-bold text-sm">%</span>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-bold text-slate-500 uppercase">ä¸‰è±UFJã‚«ãƒ¼ãƒ‰ (æœ€å¤§20%)</label>
                        <a href="https://www.cr.mufg.jp/mufgcard/point/global/save/convenience_store/index.html" target="_blank" class="text-xs text-red-600 underline hover:text-red-700">å…¬å¼è©³ç´°</a>
                    </div>
                    <div class="flex items-center bg-slate-50 rounded-xl px-4 py-3 border border-slate-200 focus-within:border-red-600 focus-within:ring-2 focus-within:ring-red-100 transition-all">
                        <input type="number" id="mufg-rate" step="0.5" class="bg-transparent w-full font-black outline-none text-red-600 text-2xl" placeholder="5.5">
                        <span class="text-slate-400 font-bold text-sm">%</span>
                    </div>
                </div>
            </div>
        </section>

        <div class="sticky top-6 z-20 mb-8">
            <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none">
                    <svg class="h-6 w-6 text-slate-400 group-focus-within:text-indigo-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                <input type="text" id="search" placeholder="åº—åãƒ»æ¡ä»¶ (ä¾‹: ãƒ¢ã‚¹ ãƒ‡ãƒªãƒãƒªãƒ¼)" 
                    class="w-full pl-14 pr-6 py-5 rounded-2xl border-none shadow-xl shadow-slate-200/50 focus:ring-4 focus:ring-indigo-500/20 outline-none text-xl font-bold placeholder-slate-300 bg-white transition-all">
            </div>
        </div>

        <div id="results" class="space-y-5"></div>

        <footer class="mt-16 text-center pb-12">
            <div id="affiliate-footer" class="mb-10 border-t border-slate-200 pt-10"></div>
            
            <div class="text-xs text-slate-400 leading-relaxed max-w-md mx-auto text-center">
                <p class="mb-3">
                    æœ¬ãƒ‡ãƒ¼ã‚¿ã¯AIè§£æã«ã‚ˆã‚‹æ¨å®šå€¤ã§ã™ã€‚<br>
                    æ­£ç¢ºãªæ¡ä»¶ã¯å¿…ãšå„å…¬å¼ã‚µã‚¤ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚
                </p>
                <p class="font-bold text-red-400 bg-red-50 inline-block px-3 py-1 rounded-lg">
                    â€»ä¸‰è±UFJã‚«ãƒ¼ãƒ‰ã®Amexãƒ–ãƒ©ãƒ³ãƒ‰ã¯ã€<br class="sm:hidden">
                    å¯¾è±¡åº—èˆ—ã‚„æ¡ä»¶ãŒå¤§ããç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
                </p>
            </div>
        </footer>
    </div>

    <script>
        let storeData = { meta: {}, stores: [] };
        
        const searchInput = document.getElementById('search');
        const smbcInput = document.getElementById('smbc-rate');
        const mufgInput = document.getElementById('mufg-rate');
        const resultsDiv = document.getElementById('results');
        const footerDiv = document.getElementById('affiliate-footer');

        smbcInput.value = localStorage.getItem('otoku-rate-smbc') || "7.0";
        mufgInput.value = localStorage.getItem('otoku-rate-mufg') || "5.5";

        [searchInput, smbcInput, mufgInput].forEach(el => el.addEventListener('input', () => {
            localStorage.setItem('otoku-rate-smbc', smbcInput.value);
            localStorage.setItem('otoku-rate-mufg', mufgInput.value);
            render();
        }));

        fetch('./data.json')
            .then(res => res.json())
            .then(data => {
                storeData = data;
                render();
            })
            .catch(err => resultsDiv.innerHTML = '<p class="text-center text-red-400 font-bold mt-10">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>');

        function normalizeKana(str) {
            if (!str) return "";
            return str.normalize('NFKC')
                      .replace(/[\u30a1-\u30f6]/g, m => String.fromCharCode(m.charCodeAt(0) - 0x60))
                      .toLowerCase();
        }

        function getSiteName(url) {
            try {
                if (!url) return "Official";
                const hostname = new URL(url).hostname;
                if (hostname.includes('moppy')) return 'Moppy';
                if (hostname.includes('hapitas')) return 'Hapitas';
                if (hostname.includes('a8.net')) return 'A8.net';
                if (hostname.includes('smbc-card')) return 'SMBC';
                if (hostname.includes('mufg')) return 'MUFG';
                
                const domainPart = hostname.replace('www.', '').split('.')[0];
                return domainPart.charAt(0).toUpperCase() + domainPart.slice(1);
            } catch {
                return "Link";
            }
        }

        function render() {
            const rawQuery = searchInput.value;
            const queries = rawQuery.trim().split(/\s+/).map(normalizeKana);
            
            const smbcRate = parseFloat(smbcInput.value) || 0;
            const mufgRate = parseFloat(mufgInput.value) || 0;

            resultsDiv.innerHTML = '';

            if (!rawQuery) {
                resultsDiv.innerHTML = '<p class="text-center text-slate-300 font-bold mt-24 text-base italic tracking-widest uppercase opacity-50 tracking-tighter">Search for store rewards</p>';
                updateFooter();
                return;
            }

            const storesArray = Array.isArray(storeData) ? storeData : (storeData.stores || []);

            let filtered = storesArray.filter(s => {
                const conditionValues = s.conditions ? Object.values(s.conditions) : [];
                const searchTargets = [
                    s.name, 
                    s.group, 
                    ...(s.aliases || []),
                    ...conditionValues
                ].map(normalizeKana);
                
                return queries.every(q => searchTargets.some(t => t.includes(q)));
            });

            filtered = filtered.map(s => ({
                ...s,
                currentRate: (s.card_type === 'SMBC') ? smbcRate : mufgRate
            })).sort((a, b) => b.currentRate - a.currentRate);

            if (filtered.length === 0) {
                resultsDiv.innerHTML = '<p class="text-center text-slate-300 font-bold mt-10">è©²å½“ãªã—</p>';
                updateFooter();
                return;
            }

            filtered.forEach(s => {
                const isSmbc = s.card_type === 'SMBC';
                const badgeColor = isSmbc ? 'bg-green-600' : 'bg-red-600';
                const rateColor = isSmbc ? 'text-green-700' : 'text-red-600';
                
                let conditionsHtml = '';
                const c = s.conditions || {};
                
                // æ–‡å­—ã‚µã‚¤ã‚ºèª¿æ•´: text-[10px] -> text-xs
                if(c.payment_method) conditionsHtml += `<div class="text-xs leading-tight text-slate-500 mb-1.5"><span class="font-bold text-slate-700">æ±ºæ¸ˆ:</span> ${c.payment_method}</div>`;
                if(c.mobile_order) conditionsHtml += `<div class="text-xs leading-tight text-slate-500 mb-1.5"><span class="font-bold text-slate-700">ã‚¹ãƒãƒ›æ³¨æ–‡:</span> ${c.mobile_order}</div>`;
                if(c.delivery) conditionsHtml += `<div class="text-xs leading-tight text-slate-500 mb-1.5"><span class="font-bold text-slate-700">é…é”:</span> ${c.delivery}</div>`;
                if(c.note) conditionsHtml += `<div class="text-xs leading-normal text-orange-700 font-medium mt-2 bg-orange-50 p-2 rounded-lg border border-orange-100">âš ï¸ ${c.note}</div>`;

                let linkHtml = '';
                if (s.official_list_url) {
                    linkHtml = `<a href="${s.official_list_url}" target="_blank" class="block mt-3 text-xs text-blue-500 underline text-right font-bold hover:text-blue-600">ğŸ“ å¯¾è±¡åº—èˆ—ãƒªã‚¹ãƒˆã‚’è¦‹ã‚‹ &rarr;</a>`;
                } else {
                    linkHtml = `<a href="${s.source_url}" target="_blank" class="block mt-3 text-xs text-slate-400 underline text-right hover:text-slate-500">å…¬å¼ã‚µã‚¤ãƒˆã§æ¡ä»¶ã‚’ç¢ºèª &rarr;</a>`;
                }

                const html = `
                <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm relative overflow-hidden group hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <span class="inline-block px-2.5 py-0.5 rounded text-[10px] font-black text-white uppercase tracking-wider mb-1.5 ${badgeColor}">
                                ${isSmbc ? 'ä¸‰äº•ä½å‹' : 'ä¸‰è±UFJ'}
                            </span>
                            ${s.group ? `<span class="ml-2 text-[10px] text-slate-400 font-bold uppercase">${s.group}</span>` : ''}
                            <h3 class="text-xl font-black text-slate-800 leading-tight">${s.name}</h3>
                        </div>
                        <div class="text-right">
                            <div class="text-4xl font-black ${rateColor} tracking-tighter">
                                ${s.currentRate}<span class="text-base ml-1">%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-slate-50 rounded-xl p-4 border border-slate-100 text-left">
                        ${conditionsHtml}
                        ${linkHtml}
                    </div>
                </div>
                `;
                resultsDiv.insertAdjacentHTML('beforeend', html);
            });
            updateFooter();
        }

        // ãƒ‡ã‚¶ã‚¤ãƒ³ä¿®æ­£ç‰ˆãƒ•ãƒƒã‚¿ãƒ¼æ›´æ–°é–¢æ•°
        function updateFooter() {
            if (!footerDiv) return;
            const meta = storeData.meta || {};
            
            const smbcUrl = meta.smbc_url || "https://www.smbc-card.com/mem/wp/vpoint_up_program/index.jsp";
            const mufgUrl = meta.mufg_url || "https://www.cr.mufg.jp/mufgcard/point/global/save/convenience_store/index.html";

            const smbcLabel = getSiteName(smbcUrl);
            const mufgLabel = getSiteName(mufgUrl);

            // ã‚³ãƒ³ãƒ†ãƒŠå¹…ã‚’åºƒã’ã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’Flex-Rowã§åˆ†é›¢
            // max-w-xs ã‚’å‰Šé™¤ã—ã€è¦ªã®å¹…ã«åˆã‚ã›ã‚‹
            footerDiv.innerHTML = `
                <div class="px-4">
                    <p class="text-xs text-slate-400 leading-relaxed max-w-lg mx-auto mb-8 font-medium italic">
                        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ©ç›Šã®ãªã„ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯ã‚ˆã‚Šã‚‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼é‚„å…ƒãŒå¤§ãã„é¸æŠè‚¢ã‚’æç¤ºã™ã‚‹ã“ã¨ãŒã€æœ¬ãƒ„ãƒ¼ãƒ«ã®æŒç¶šçš„ãªä¿¡é ¼ã«ç¹‹ãŒã‚‹ã¨åˆ¤æ–­ã—ã¦ã„ã¾ã™ã€‚
                    </p>
                    <div class="flex flex-col gap-4 max-w-xl mx-auto">
                        
                        <a href="${smbcUrl}" target="_blank" class="flex flex-row items-center justify-between gap-6 px-6 py-4 bg-white border border-slate-200 rounded-xl text-slate-700 active:bg-slate-50 transition-all shadow-sm shadow-slate-200/50 hover:shadow-md hover:border-green-200 group">
                            <div class="flex-1 text-left">
                                <span class="block font-bold text-sm leading-snug group-hover:text-green-700 transition-colors">
                                    ${meta.smbc_catch || 'ä¸‰äº•ä½å‹ã‚«ãƒ¼ãƒ‰ç™ºè¡Œ'}
                                </span>
                            </div>
                            <div class="shrink-0">
                                <span class="text-slate-400 text-[10px] font-black uppercase bg-slate-100 px-2 py-1 rounded border border-slate-200 group-hover:bg-green-50 group-hover:text-green-600 group-hover:border-green-100 transition-colors">
                                    ${smbcLabel} â†—
                                </span>
                            </div>
                        </a>

                        <a href="${mufgUrl}" target="_blank" class="flex flex-row items-center justify-between gap-6 px-6 py-4 bg-white border border-slate-200 rounded-xl text-slate-700 active:bg-slate-50 transition-all shadow-sm shadow-slate-200/50 hover:shadow-md hover:border-red-200 group">
                            <div class="flex-1 text-left">
                                <span class="block font-bold text-sm leading-snug group-hover:text-red-700 transition-colors">
                                    ${meta.mufg_catch || 'ä¸‰è±UFJã‚«ãƒ¼ãƒ‰ç™ºè¡Œ'}
                                </span>
                            </div>
                            <div class="shrink-0">
                                <span class="text-slate-400 text-[10px] font-black uppercase bg-slate-100 px-2 py-1 rounded border border-slate-200 group-hover:bg-red-50 group-hover:text-red-600 group-hover:border-red-100 transition-colors">
                                    ${mufgLabel} â†—
                                </span>
                            </div>
                        </a>

                    </div>
                </div>`;
        }
    </script>
</body>
</html>
