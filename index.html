<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŠãƒˆã‚¯é‚„å…ƒãƒã‚§ãƒƒã‚«ãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; background-color: #f1f5f9; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
    </style>
</head>
<body class="min-h-screen pb-20 text-slate-800">
    <div class="max-w-xl mx-auto px-4 pt-8">
        <header class="mb-6">
            <h1 class="text-3xl font-black text-slate-900 tracking-tighter italic">é‚„å…ƒãƒã‚§ãƒƒã‚«ãƒ¼</h1>
            <p class="text-xs font-bold text-slate-400 mt-1 uppercase tracking-widest">Logic-based Reward Analysis</p>
        </header>

        <section class="bg-white rounded-2xl p-5 mb-6 border border-slate-200 card-shadow">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase">ä¸‰äº•ä½å‹ã‚«ãƒ¼ãƒ‰ (æœ€å¤§7%)</label>
                        <a href="https://www.smbc-card.com/mem/wp/vpoint_up_program/index.jsp" target="_blank" class="text-[10px] text-green-600 underline">å…¬å¼è©³ç´°</a>
                    </div>
                    <div class="flex items-center bg-slate-50 rounded-xl px-3 py-2 border border-slate-200 focus-within:border-green-600 focus-within:ring-2 focus-within:ring-green-100 transition-all">
                        <input type="number" id="smbc-rate" step="0.5" class="bg-transparent w-full font-black outline-none text-green-700 text-xl" placeholder="7.0">
                        <span class="text-slate-400 font-bold text-xs">%</span>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase">ä¸‰è±UFJã‚«ãƒ¼ãƒ‰ (æœ€å¤§19%)</label>
                        <a href="https://www.cr.mufg.jp/mufgcard/point/global/save/convenience_store/index.html" target="_blank" class="text-[10px] text-red-600 underline">å…¬å¼è©³ç´°</a>
                    </div>
                    <div class="flex items-center bg-slate-50 rounded-xl px-3 py-2 border border-slate-200 focus-within:border-red-600 focus-within:ring-2 focus-within:ring-red-100 transition-all">
                        <input type="number" id="mufg-rate" step="0.5" class="bg-transparent w-full font-black outline-none text-red-600 text-xl" placeholder="5.5">
                        <span class="text-slate-400 font-bold text-xs">%</span>
                    </div>
                </div>
            </div>
        </section>

        <div class="sticky top-4 z-20 mb-6">
            <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-slate-400 group-focus-within:text-indigo-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                <input type="text" id="search" placeholder="åº—åãƒ»æ¡ä»¶ (ä¾‹: ãƒ¢ã‚¹ ãƒ‡ãƒªãƒãƒªãƒ¼)" 
                    class="w-full pl-11 pr-4 py-4 rounded-2xl border-none shadow-xl shadow-slate-200/50 focus:ring-4 focus:ring-indigo-500/20 outline-none text-lg font-bold placeholder-slate-300 bg-white transition-all">
            </div>
        </div>

        <div id="results" class="space-y-4"></div>

        <footer class="mt-12 text-center pb-8">
            <div id="affiliate-footer" class="mb-8 border-t border-slate-200 pt-8"></div>
            
            <div class="text-[10px] text-slate-400 leading-relaxed max-w-xs mx-auto text-center">
                <p class="mb-2">
                    æœ¬ãƒ‡ãƒ¼ã‚¿ã¯AIè§£æã«ã‚ˆã‚‹æ¨å®šå€¤ã§ã™ã€‚<br>
                    æ­£ç¢ºãªæ¡ä»¶ã¯å¿…ãšå„å…¬å¼ã‚µã‚¤ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚
                </p>
                <p class="font-bold text-red-400">
                    â€»ä¸‰è±UFJã‚«ãƒ¼ãƒ‰ã®Amexãƒ–ãƒ©ãƒ³ãƒ‰ã¯ã€<br>
                    å¯¾è±¡åº—èˆ—ã‚„æ¡ä»¶ãŒå¤§ããç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
                </p>
            </div>
        </footer>
    </div>

    <script>
        // ã€æ”¹è‰¯ã€‘JSONã®è¾æ›¸æ§‹é€  (meta, stores) ã‚’æ ¼ç´ã§ãã‚‹ã‚ˆã†ã«åˆæœŸåŒ–
        let storeData = { meta: {}, stores: [] };
        
        const MOPPY_LINKS = {
            'SMBC': 'https://pc.moppy.jp/entry/invite.php?invite=Gupre100&s_id=149052',
            'MUFG': 'https://pc.moppy.jp/entry/invite.php?invite=Gupre100&s_id=157374'
        };

        const searchInput = document.getElementById('search');
        const smbcInput = document.getElementById('smbc-rate');
        const mufgInput = document.getElementById('mufg-rate');
        const resultsDiv = document.getElementById('results');
        const footerDiv = document.getElementById('affiliate-footer');

        smbcInput.value = localStorage.getItem('otoku-rate-smbc') || "7.0";
        mufgInput.value = localStorage.getItem('otoku-rate-mufg') || "5.5";

        [searchInput, smbcInput, mufgInput].forEach(el => el.addEventListener('input', () => {
            localStorage.setItem('otoku-rate-smbc', smbcInput.value);
            localStorage.setItem('otoku-rate-mufg', mufgInput.value);
            render();
        }));

        fetch('./data.json')
            .then(res => res.json())
            .then(data => {
                // é…åˆ—ã ã£ãŸå ´åˆã‚‚è€ƒæ…®ã—ã¦ã€æ­£å¸¸ã«è¾æ›¸æ§‹é€ ã¸ãƒãƒ¼ã‚¸
                storeData = data;
                render();
            })
            .catch(err => resultsDiv.innerHTML = '<p class="text-center text-red-400 font-bold mt-10">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>');

        function normalizeKana(str) {
            if (!str) return "";
            return str.normalize('NFKC')
                      .replace(/[\u30a1-\u30f6]/g, m => String.fromCharCode(m.charCodeAt(0) - 0x60))
                      .toLowerCase();
        }

        function render() {
            const rawQuery = searchInput.value;
            const queries = rawQuery.trim().split(/\s+/).map(normalizeKana);
            
            const smbcRate = parseFloat(smbcInput.value) || 0;
            const mufgRate = parseFloat(mufgInput.value) || 0;

            resultsDiv.innerHTML = '';

            if (!rawQuery) {
                resultsDiv.innerHTML = '<p class="text-center text-slate-300 font-bold mt-20 text-sm italic tracking-widest uppercase opacity-50 tracking-tighter">Search for store rewards</p>';
                updateFooter(); // æœªå…¥åŠ›æ™‚ã‚‚ãƒ•ãƒƒã‚¿ãƒ¼ã‚’è¡¨ç¤º
                return;
            }

            // ã€æ”¹è‰¯ã€‘storesã‚­ãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã€‚æ—§æ¥ã®é…åˆ—å½¢å¼ã§ã‚‚å‹•ä½œã™ã‚‹ã‚ˆã†ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            const storesArray = Array.isArray(storeData) ? storeData : (storeData.stores || []);

            let filtered = storesArray.filter(s => {
                const conditionValues = s.conditions ? Object.values(s.conditions) : [];
                const searchTargets = [
                    s.name, 
                    s.group, 
                    ...(s.aliases || []),
                    ...conditionValues
                ].map(normalizeKana);
                
                return queries.every(q => searchTargets.some(t => t.includes(q)));
            });

            filtered = filtered.map(s => ({
                ...s,
                currentRate: (s.card_type === 'SMBC') ? smbcRate : mufgRate
            })).sort((a, b) => b.currentRate - a.currentRate);

            if (filtered.length === 0) {
                resultsDiv.innerHTML = '<p class="text-center text-slate-300 font-bold mt-10">è©²å½“ãªã—</p>';
                updateFooter();
                return;
            }

            filtered.forEach(s => {
                const isSmbc = s.card_type === 'SMBC';
                const badgeColor = isSmbc ? 'bg-green-600' : 'bg-red-600';
                const rateColor = isSmbc ? 'text-green-700' : 'text-red-600';
                
                let conditionsHtml = '';
                const c = s.conditions || {};
                
                if(c.payment_method) conditionsHtml += `<div class="text-[10px] leading-tight text-slate-500 mb-1"><span class="font-bold text-slate-700">æ±ºæ¸ˆ:</span> ${c.payment_method}</div>`;
                if(c.mobile_order) conditionsHtml += `<div class="text-[10px] leading-tight text-slate-500 mb-1"><span class="font-bold text-slate-700">ã‚¹ãƒãƒ›æ³¨æ–‡:</span> ${c.mobile_order}</div>`;
                if(c.delivery) conditionsHtml += `<div class="text-[10px] leading-tight text-slate-500 mb-1"><span class="font-bold text-slate-700">é…é”:</span> ${c.delivery}</div>`;
                if(c.note) conditionsHtml += `<div class="text-[10px] leading-tight text-orange-600 font-bold mt-1 bg-orange-50 p-1 rounded border border-orange-100">âš ï¸ ${c.note}</div>`;

                let linkHtml = '';
                if (s.official_list_url) {
                    linkHtml = `<a href="${s.official_list_url}" target="_blank" class="block mt-2 text-[10px] text-blue-500 underline text-right font-bold">ğŸ“ å¯¾è±¡åº—èˆ—ãƒªã‚¹ãƒˆã‚’è¦‹ã‚‹ &rarr;</a>`;
                } else {
                    linkHtml = `<a href="${s.source_url}" target="_blank" class="block mt-2 text-[10px] text-slate-400 underline text-right">å…¬å¼ã‚µã‚¤ãƒˆã§æ¡ä»¶ã‚’ç¢ºèª &rarr;</a>`;
                }

                const html = `
                <div class="bg-white rounded-2xl p-5 border border-slate-100 shadow-sm relative overflow-hidden">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="inline-block px-2 py-0.5 rounded text-[9px] font-black text-white uppercase tracking-wider mb-1 ${badgeColor}">
                                ${isSmbc ? 'ä¸‰äº•ä½å‹' : 'ä¸‰è±UFJ'}
                            </span>
                            ${s.group ? `<span class="ml-1 text-[9px] text-slate-400 font-bold uppercase">${s.group}</span>` : ''}
                            <h3 class="text-lg font-black text-slate-800 leading-tight">${s.name}</h3>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-black ${rateColor} tracking-tighter">
                                ${s.currentRate}<span class="text-sm ml-0.5">%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-slate-50 rounded-xl p-3 border border-slate-100 text-left">
                        ${conditionsHtml}
                        ${linkHtml}
                    </div>
                </div>
                `;
                resultsDiv.insertAdjacentHTML('beforeend', html);
            });
            updateFooter();
        }

        // ã€æ”¹è‰¯ã€‘JSONå†…ã®ç´¹ä»‹æ–‡ (meta) ã‚’ãƒ•ãƒƒã‚¿ãƒ¼ã«åæ˜ 
        function updateFooter() {
            if (!footerDiv) return;
            const meta = storeData.meta || {};
            footerDiv.innerHTML = `
                <div class="px-4">
                    <p class="text-[9px] text-slate-400 leading-relaxed max-w-xs mx-auto mb-6 font-medium italic">
                        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ©ç›Šã®ãªã„ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯ã‚ˆã‚Šã‚‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼é‚„å…ƒãŒå¤§ãã„é¸æŠè‚¢ã‚’æç¤ºã™ã‚‹ã“ã¨ãŒã€æœ¬ãƒ„ãƒ¼ãƒ«ã®æŒç¶šçš„ãªä¿¡é ¼ã«ç¹‹ãŒã‚‹ã¨åˆ¤æ–­ã—ã¦ã„ã¾ã™ã€‚
                    </p>
                    <div class="flex flex-col gap-2 max-w-xs mx-auto">
                        <a href="${MOPPY_LINKS.SMBC}" target="_blank" class="flex justify-between items-center px-4 py-2 bg-white border border-slate-200 rounded-lg text-[10px] text-slate-600 active:bg-slate-50 transition-colors shadow-sm shadow-slate-200/50">
                            <span class="font-black tracking-tight">${meta.smbc_catch || 'ä¸‰äº•ä½å‹ã‚«ãƒ¼ãƒ‰ç™ºè¡Œ'}</span>
                            <span class="text-slate-300 text-[8px] font-black uppercase">Moppy â†—</span>
                        </a>
                        <a href="${MOPPY_LINKS.MUFG}" target="_blank" class="flex justify-between items-center px-4 py-2 bg-white border border-slate-200 rounded-lg text-[10px] text-slate-600 active:bg-slate-50 transition-colors shadow-sm shadow-slate-200/50">
                            <span class="font-black tracking-tight">${meta.mufg_catch || 'ä¸‰è±UFJã‚«ãƒ¼ãƒ‰ç™ºè¡Œ'}</span>
                            <span class="text-slate-300 text-[8px] font-black uppercase">Moppy â†—</span>
                        </a>
                    </div>
                </div>`;
        }
    </script>
</body>
</html>
